<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Interactive Grid Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
  <style>
    html, body {
      margin: 0;
      height: 100%;
      background: black;
    }
    .frame {
      width: 100%;
      height: 100vh;
      background: url('ravenquest-bg.png') center center no-repeat;
      background-size: contain;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
    }
    #map {
      width: 800px;
      height: 800px;
      box-shadow: 0 0 20px rgba(0,0,0,0.5);
    }
    .leaflet-div-icon {
      background: none !important;
      border: none !important;
    }
    .grid-label {
      font-size: 10px;
      color: black;
      position: absolute;
      pointer-events: none;
    }
    .grid-border {
      font-weight: bold;
      font-size: 14px;
      color: black;
      background: transparent;
    }
    .logo {
      position: absolute;
      bottom: 20px;
      right: 50%;
      transform: translateX(50%);
      background-color: gold;
      color: white;
      font-weight: bold;
      padding: 6px 14px;
      font-size: 18px;
      border-radius: 10px;
      z-index: 1000;
    }
    .toggle-panel {
      position: absolute;
      top: 10px;
      left: 10px;
      background: white;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 8px;
      z-index: 1000;
      font-size: 14px;
    }
    .toggle-panel label {
      display: block;
    }
    .undo-button {
      position: absolute;
      top: 10px;
      right: 10px;
      background-color: #f5f5f5;
      border: 1px solid #888;
      padding: 6px 12px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
      z-index: 1000;
    }
  </style>
</head>
<body>
  <div class="frame">
    <div id="map"></div>
    <div class="logo">FAM GUILD</div>
    <div class="toggle-panel">
      <label><input type="checkbox" id="toggleMarkers" checked /> Show All Markers</label>
      <label><input type="checkbox" class="type-toggle" data-type="fish" checked /> Fish ‚ùå</label>
      <label><input type="checkbox" class="type-toggle" data-type="mining" checked /> Mining ‚õèÔ∏è</label>
      <label><input type="checkbox" class="type-toggle" data-type="herb" checked /> Herb üåø</label>
      <label><input type="checkbox" class="type-toggle" data-type="quest" checked /> Quest ‚ùó</label>
      <label><input type="checkbox" class="type-toggle" data-type="dynamic" checked /> Dynamic ‚öîÔ∏è</label>
    </div>
    <button class="undo-button" id="undoBtn">Undo Delete</button>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import {
      getDatabase,
      ref,
      push,
      onChildAdded,
      remove,
      set
    } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

    const firebaseConfig = {
      apiKey: \"AIzaSyDHW-dBKqMEJ2ym1sMmjao03iK7JQLiB94\",
      authDomain: "map-data-base-620d3.firebaseapp.com",
      databaseURL: "https://map-data-base-620d3-default-rtdb.firebaseio.com",
      projectId: "map-data-base-620d3",
      storageBucket: "map-data-base-620d3.appspot.com",
      messagingSenderId: "765561070786",
      appId: "1:765561070786:web:f4e1e44c9284ea6ff8075b",
      measurementId: "G-4NTXWDK5G0"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const markerRef = ref(db, "markers");
    let lastDeleted = null;

    const markerIcons = {
      fish: '‚ùå',
      mining: '‚õèÔ∏è',
      herb: 'üåø',
      quest: '‚ùó',
      dynamic: '‚öîÔ∏è'
    };

    const map = L.map('map', {
      crs: L.CRS.Simple,
      minZoom: -2,
      maxZoom: 2,
    });

    const cols = 26;
    const rows = 26;
    const cellSize = 30;
    const width = cols * cellSize;
    const height = rows * cellSize;
    const bounds = [[0, 0], [height, width]];

    L.imageOverlay("map-bg.png", bounds).addTo(map);
    map.setMaxBounds(bounds);
    map.fitBounds(bounds);

    for (let row = 0; row < rows; row++) {
      for (let col = 0; col < cols; col++) {
        const y = row * cellSize + 5;
        const x = col * cellSize + 5;
        const label = String.fromCharCode(65 + col) + (row + 1);
        const divIcon = L.divIcon({ className: 'grid-label', html: label, iconSize: [0, 0] });
        L.marker([y, x], { icon: divIcon, interactive: false }).addTo(map);
      }
    }

    for (let i = 0; i <= cols; i++) {
      const x = i * cellSize;
      L.polyline([[0, x], [height, x]], { color: 'black', weight: 1 }).addTo(map);
    }
    for (let j = 0; j <= rows; j++) {
      const y = j * cellSize;
      L.polyline([[y, 0], [y, width]], { color: 'black', weight: 1 }).addTo(map);
    }

    for (let i = 0; i < cols; i++) {
      const label = String.fromCharCode(65 + i);
      const x = i * cellSize + cellSize / 2;
      L.marker([0, x], { icon: L.divIcon({ className: 'grid-border', html: label }), interactive: false }).addTo(map);
      L.marker([height, x], { icon: L.divIcon({ className: 'grid-border', html: label }), interactive: false }).addTo(map);
    }
    for (let j = 0; j < rows; j++) {
      const y = j * cellSize + cellSize / 2;
      L.marker([y, 0], { icon: L.divIcon({ className: 'grid-border', html: j + 1 }), interactive: false }).addTo(map);
      L.marker([y, width], { icon: L.divIcon({ className: 'grid-border', html: j + 1 }), interactive: false }).addTo(map);
    }

    const typeLayers = {
      fish: L.layerGroup().addTo(map),
      mining: L.layerGroup().addTo(map),
      herb: L.layerGroup().addTo(map),
      quest: L.layerGroup().addTo(map),
      dynamic: L.layerGroup().addTo(map)
    };

    document.getElementById('toggleMarkers').addEventListener('change', (e) => {
      const checked = e.target.checked;
      Object.values(typeLayers).forEach(layer => checked ? map.addLayer(layer) : map.removeLayer(layer));
    });

    document.querySelectorAll('.type-toggle').forEach(cb => {
      cb.addEventListener('change', (e) => {
        const type = e.target.getAttribute('data-type');
        if (e.target.checked) {
          map.addLayer(typeLayers[type]);
        } else {
          map.removeLayer(typeLayers[type]);
        }
      });
    });

    function checkPassword() {
      const stored = sessionStorage.getItem('adminPassword');
      if (stored === 'Pumpitup') return true;
      const input = prompt("Enter admin password:");
      if (input === 'Pumpitup') {
        sessionStorage.setItem('adminPassword', 'Pumpitup');
        return true;
      }
      alert("Incorrect password.");
      return false;
    }

    function createMarker(data, key) {
      const icon = L.divIcon({ html: `<div style='font-size: 14px;'>${markerIcons[data.type]}</div>` });
      const marker = L.marker([data.lat, data.lng], { icon });
      marker.bindPopup(`<b>${data.type.toUpperCase()}</b><br>${data.name || ''}<br><button onclick="window.deleteMarker('${key}', ${JSON.stringify(data).replace(/"/g, '&quot;')})">Delete</button>`);
      typeLayers[data.type].addLayer(marker);
    }

    window.deleteMarker = function (key, data) {
      if (!checkPassword()) return;
      if (confirm('Delete marker?')) {
        lastDeleted = { key, data };
        remove(ref(db, 'markers/' + key));
      }
    }

    onChildAdded(markerRef, snapshot => {
      const data = snapshot.val();
      createMarker(data, snapshot.key);
    });

    map.on('click', function (e) {
      if (!checkPassword()) return;
      const type = prompt("Enter marker type: fish, mining, herb, quest, dynamic");
      if (!markerIcons[type]) return alert("Invalid type.");
      let name = "";
      if (type !== 'fish') {
        name = prompt("Enter custom name for this marker:") || "";
      }
      push(markerRef, { lat: e.latlng.lat, lng: e.latlng.lng, type, name, authKey: 'Pumpitup' });
    });

    document.getElementById("undoBtn").addEventListener("click", () => {
      if (lastDeleted) {
        set(ref(db, 'markers/' + lastDeleted.key), { ...lastDeleted.data, authKey: 'Pumpitup' });
        alert("Marker restored.");
        lastDeleted = null;
      } else {
        alert("Nothing to undo.");
      }
    });
  </script>
</body>
</html>
